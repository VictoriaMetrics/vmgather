name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

permissions:
  contents: read

env:
  GOVULNCHECK_VERSION: v1.1.4

jobs:
  govulncheck:
    name: Go Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.25.7"

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@${GOVULNCHECK_VERSION}
          govulncheck ./...

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run gitleaks
        run: |
          docker run --rm -v "$PWD:/work" -w /work zricethezav/gitleaks:v8.24.2 \
            detect --source . --no-git --config .gitleaks.toml --redact

      - name: Run trufflehog (verified only)
        run: |
          docker run --rm -v "$PWD:/work" trufflesecurity/trufflehog:3.93.3 \
            git file:///work --results=verified --fail

  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run hadolint
        run: |
          docker run --rm -i hadolint/hadolint:v2.12.0 < build/docker/Dockerfile.vmgather
          docker run --rm -i hadolint/hadolint:v2.12.0 < build/docker/Dockerfile.vmimporter

      - name: Run trivy config checks
        run: |
          docker run --rm -v "$PWD:/work" -w /work aquasec/trivy:0.65.0 \
            config --severity HIGH,CRITICAL --exit-code 1 build/docker/Dockerfile.vmgather
          docker run --rm -v "$PWD:/work" -w /work aquasec/trivy:0.65.0 \
            config --severity HIGH,CRITICAL --exit-code 1 build/docker/Dockerfile.vmimporter

  image-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build local images
        run: make docker-build PLATFORMS=linux/amd64

      - name: Scan images with trivy
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.65.0 \
            image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 victoriametrics/vmgather:local
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.65.0 \
            image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 victoriametrics/vmimporter:local
