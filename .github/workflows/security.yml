name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  govulncheck:
    name: Go Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run hadolint
        run: |
          docker run --rm -i hadolint/hadolint:v2.12.0 < build/docker/Dockerfile.vmgather
          docker run --rm -i hadolint/hadolint:v2.12.0 < build/docker/Dockerfile.vmimporter

      - name: Run trivy config checks
        run: |
          docker run --rm -v "$PWD:/work" -w /work aquasec/trivy:0.65.0 \
            config --severity HIGH,CRITICAL --exit-code 1 build/docker/Dockerfile.vmgather
          docker run --rm -v "$PWD:/work" -w /work aquasec/trivy:0.65.0 \
            config --severity HIGH,CRITICAL --exit-code 1 build/docker/Dockerfile.vmimporter

  image-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - name: Build local images
        run: make docker-build PLATFORMS=linux/amd64

      - name: Scan images with trivy
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.65.0 \
            image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 victoriametrics/vmgather:local
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.65.0 \
            image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 victoriametrics/vmimporter:local
