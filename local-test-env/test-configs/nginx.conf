events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream definitions
    upstream vmauth_cluster {
        server vmauth-cluster:8426;
    }

    upstream vmauth_single {
        server vmauth-single:8427;
    }

    upstream vmsingle {
        server vmsingle-noauth:8428;
    }

    upstream vmselect {
        server vmselect:8481;
    }

    # Server block - simulates vm.example.com domain
    server {
        listen 80;
        server_name vm.example.com localhost;

        # ========================================================================
        # VMAuth Cluster endpoint with tenant support
        # ========================================================================
        # This simulates VictoriaMetrics Managed (MaaS) behavior:
        # - /1011/rw/prometheus → read+write endpoint (query works, export doesn't)
        # - /1011/r/prometheus → read-only endpoint (query and export work)
        # - /1011/prometheus → standard endpoint (everything works)
        #
        # Examples:
        # - http://vm.example.com:8888/1011/rw/prometheus/api/v1/query ✅
        # - http://vm.example.com:8888/1011/rw/prometheus/api/v1/export ❌ (missing route)
        # - http://vm.example.com:8888/1011/r/prometheus/api/v1/export ✅
        # - http://vm.example.com:8888/1011/prometheus/api/v1/export ✅
        
        # /rw/prometheus paths - query works, export doesn't (by design)
        location ~ ^/(\d+)/rw/prometheus/(.*)$ {
            set $tenant $1;
            set $path $2;
            # Strip /1011/rw/prometheus, keep only /api/v1/...
            # VMAuth will add /select/<tenant>/prometheus
            proxy_pass http://vmauth_cluster/$path$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass_request_headers on;
            proxy_read_timeout 300s;
        }
        
        # /r/prometheus paths - both query and export work
        location ~ ^/(\d+)/r/prometheus/(.*)$ {
            set $tenant $1;
            set $path $2;
            # Strip /1011/r/prometheus, keep only /api/v1/...
            proxy_pass http://vmauth_cluster/$path$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass_request_headers on;
            proxy_read_timeout 300s;
        }
        
        # Standard /prometheus paths - everything works
        location ~ ^/(\d+)/prometheus/(.*)$ {
            set $tenant $1;
            set $path $2;
            # Strip /1011/prometheus, keep only /api/v1/...
            proxy_pass http://vmauth_cluster/$path$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass_request_headers on;
            proxy_read_timeout 300s;
        }

        # VMAuth Single endpoint
        location /vmauth/ {
            rewrite ^/vmauth/(.*)$ /$1 break;
            proxy_pass http://vmauth_single;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # VMSingle direct endpoint
        location /vmsingle/ {
            rewrite ^/vmsingle/(.*)$ /$1 break;
            proxy_pass http://vmsingle;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # VMSelect direct endpoint
        location /vmselect/ {
            rewrite ^/vmselect/(.*)$ /$1 break;
            proxy_pass http://vmselect;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Health check
        location /health {
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}

